<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3D Firework Mobile - smallbrandings</title>
    <link href="https://fonts.googleapis.com/css2?family=Aboreto&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: 'Aboreto', cursive; color: #fff; touch-action: none; user-select: none; }
        canvas { display: block; touch-action: none; }
        
        #intro-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.8s; }
        #intro-layer h1 { font-size: 8vw; letter-spacing: 10px; margin: 0; animation: pulse 2s infinite; }
        #intro-layer p { font-size: 12px; margin-top: 15px; opacity: 0.5; font-family: sans-serif; }
        @keyframes pulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 1; } }

        .top-right-ui { position: fixed; top: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end; gap: 8px; z-index: 101; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        .top-right-ui.visible { opacity: 1; pointer-events: auto; }
        .control-panel { background: rgba(255, 255, 255, 0.08); padding: 10px; border-radius: 12px; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .control-group { display: flex; flex-direction: column; align-items: flex-end; margin-bottom: 5px; }
        .control-group label { font-size: 8px; margin-bottom: 2px; opacity: 0.6; }
        input[type="range"] { width: 80px; accent-color: #fff; }
        
        .guide-text { position: fixed; bottom: 20px; width: 100%; text-align: center; font-size: 9px; opacity: 0.3; letter-spacing: 1px; pointer-events: none; }
    </style>
</head>
<body>

<div id="intro-layer">
    <h1>FIREWORK 3D</h1>
    <p>TAP TO START</p>
</div>

<div class="top-right-ui" id="right-ui">
    <div class="control-panel">
        <div class="control-group">
            <label>SIZE</label>
            <input type="range" id="size-slider" min="2" max="20" value="8">
        </div>
        <div class="control-group">
            <label>DENSITY</label>
            <input type="range" id="density-slider" min="5" max="50" value="25">
        </div>
    </div>
</div>

<div class="guide-text">DRAG TO ROTATE / TAP TO FIRE</div>
<canvas id="canvas"></canvas>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const intro = document.getElementById('intro-layer');
    const rightUi = document.getElementById('right-ui');
    const sizeSlider = document.getElementById('size-slider');
    const densitySlider = document.getElementById('density-slider');

    let particles = [];
    let angleX = 0, angleY = 0;
    let targetAngleX = 0, targetAngleY = 0;
    let isDragging = false;
    let startX, startY;
    let hasMoved = false;

    const dpr = window.devicePixelRatio || 1;

    function resize() {
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        ctx.scale(dpr, dpr);
    }
    window.addEventListener('resize', resize);
    resize();

    // 시작 화면 터치
    intro.addEventListener('touchstart', (e) => {
        intro.style.opacity = '0';
        setTimeout(() => { intro.style.display = 'none'; rightUi.classList.add('visible'); }, 800);
    });

    // 터치 이벤트 제어
    window.addEventListener('touchstart', (e) => {
        if (e.target.closest('.top-right-ui')) return;
        isDragging = true;
        hasMoved = false;
        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
    }, { passive: false });

    window.addEventListener('touchmove', (e) => {
        if (!isDragging) return;
        let dx = e.touches[0].clientX - startX;
        let dy = e.touches[0].clientY - startY;
        
        if (Math.abs(dx) > 5 || Math.abs(dy) > 5) hasMoved = true;

        targetAngleY += dx * 0.005;
        targetAngleX += dy * 0.005;

        startX = e.touches[0].clientX;
        startY = e.touches[0].clientY;
        e.preventDefault(); // 스크롤 방지
    }, { passive: false });

    window.addEventListener('touchend', (e) => {
        if (!hasMoved && !e.target.closest('.top-right-ui') && intro.style.display === 'none') {
            // 탭했을 때 (이동이 거의 없을 때) 폭죽 생성
            const touch = e.changedTouches[0];
            createExplosion(touch.clientX - window.innerWidth/2, touch.clientY - window.innerHeight/2);
        }
        isDragging = false;
    });

    class Particle {
        constructor(x, y, z, color) {
            this.x = x; this.y = y; this.z = z;
            const speed = Math.random() * 6 + 1;
            const theta = Math.random() * Math.PI * 2;
            const phi = Math.random() * Math.PI;

            this.vx = Math.sin(phi) * Math.cos(theta) * speed;
            this.vy = Math.sin(phi) * Math.sin(theta) * speed;
            this.vz = Math.cos(phi) * speed;

            this.friction = 0.94;
            this.gravity = 0.12;
            this.alpha = 1;
            this.decay = Math.random() * 0.02 + 0.01;
            this.hue = color;
            this.sizeBase = (sizeSlider.value / 10);
        }

        update() {
            this.vx *= this.friction; this.vy *= this.friction; this.vz *= this.friction;
            this.vy += this.gravity;
            this.x += this.vx; this.y += this.vy; this.z += this.vz;
            this.alpha -= this.decay;
        }

        draw() {
            // 보간법을 이용한 부드러운 회전
            angleX += (targetAngleX - angleX) * 0.1;
            angleY += (targetAngleY - angleY) * 0.1;

            // 회전 행렬
            let x1 = this.x * Math.cos(angleY) + this.z * Math.sin(angleY);
            let z1 = this.z * Math.cos(angleY) - this.x * Math.sin(angleY);
            let y2 = this.y * Math.cos(angleX) - z1 * Math.sin(angleX);
            let z2 = z1 * Math.cos(angleX) + this.y * Math.sin(angleX);

            const fov = 400; 
            const scale = fov / (fov + z2);
            const px = x1 * scale + window.innerWidth / 2;
            const py = y2 * scale + window.innerHeight / 2;

            if (this.alpha > 0 && z2 > -fov) {
                ctx.fillStyle = `hsla(${this.hue}, 100%, 75%, ${this.alpha})`;
                ctx.beginPath();
                ctx.arc(px, py, this.sizeBase * scale * 1.5, 0, Math.PI * 2);
                ctx.fill();
            }
        }
    }

    function createExplosion(x, y) {
        const color = Math.random() * 360;
        const count = densitySlider.value * 8;
        for (let i = 0; i < count; i++) {
            particles.push(new Particle(x, y, 0, color));
        }
    }

    function loop() {
        ctx.globalCompositeOperation = 'destination-out';
        ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
        ctx.fillRect(0, 0, window.innerWidth, window.innerHeight);
        ctx.globalCompositeOperation = 'lighter';

        for (let i = particles.length - 1; i >= 0; i--) {
            particles[i].update();
            particles[i].draw();
            if (particles[i].alpha <= 0) particles.splice(i, 1);
        }
        requestAnimationFrame(loop);
    }

    loop();
</script>
</body>
</html>
